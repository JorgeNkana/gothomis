ALTER TABLE opd_patients ADD COLUMN IF NOT EXISTS is_admitted BOOLEAN;
ALTER TABLE tbl_accounts_numbers ADD COLUMN IF NOT EXISTS is_submitted tinyint null;
ALTER TABLE tbl_accounts_numbers ADD COLUMN IF NOT EXISTS visit_close  tinyint default 1;
ALTER TABLE opd_patients ADD COLUMN IF NOT EXISTS card_no varchar(50) null;
ALTER TABLE opd_patients ADD COLUMN IF NOT EXISTS authorization_number varchar(50) null;
ALTER TABLE opd_patients ADD COLUMN IF NOT EXISTS department_id int null;

DELIMITER //
DROP TRIGGER IF EXISTS `opd_patients`//
CREATE OR REPLACE TRIGGER `opd_patients` AFTER UPDATE ON tbl_accounts_numbers FOR EACH ROW BEGIN IF OLD.visit_close = 1 AND NEW.visit_close = 0 THEN DELETE FROM opd_patients WHERE patient_id = NEW.patient_id; ELSEIF NEW.main_category_id IS NOT NULL THEN DELETE FROM opd_patients WHERE patient_id = NEW.patient_id OR (is_admitted IS NOT TRUE AND TIMESTAMPDIFF(DAY,visit_date,CURRENT_DATE) > (SELECT t1.days FROM tbl_reattendance_free_days t1 WHERE t1.facility_id = NEW.facility_id)) OR (is_admitted AND NOT EXISTS (SELECT t1.id FROM tbl_admissions t1 WHERE t1.account_id = NEW.id AND t1.admission_status_id NOT IN (1,2,3) )); INSERT INTO opd_patients(`patient_id`,`first_name`,`middle_name`,`last_name`,`medical_record_number`,`name`,`residence_id`,`dob`,`age`,`gender`,`account_number`,`status`,`tallied`,`account_id`,`visit_date`,`payment_filter` ,`bill_id`,`sub_category_name`,`main_category_id`,`search_key`,`facility_id`,`is_admitted`, `card_no`, `authorization_number`, `department_id`)SELECT t1.id,t1.first_name,t1.middle_name,t1.last_name,t1.medical_record_number,CONCAT(t1.first_name,' ',ifnull(t1.middle_name,''),' ',ifnull(t1.last_name,''), ' ', t1.medical_record_number), t1.residence_id,t1.dob,CASE WHEN STR_TO_DATE(dob,'%Y-%m-%d') IS NOT NULL THEN CASE WHEN TIMESTAMPDIFF(YEAR,dob, CURRENT_DATE) <> 0 THEN CONCAT(TIMESTAMPDIFF(YEAR,dob, CURRENT_DATE), ' Years') ELSE CASE WHEN TIMESTAMPDIFF(MONTH,dob, CURRENT_DATE) <> 0 THEN CONCAT(TIMESTAMPDIFF(MONTH, dob, CURRENT_DATE), ' Months') ELSE CONCAT(TIMESTAMPDIFF(DAY, dob, CURRENT_DATE), ' Days') END END ELSE dob END,t1.gender,NEW.account_number,NEW.status,NEW.tallied,NEW.id,NEW.date_attended,NEW.patient_category_id,NEW.patient_category_id,NEW.sub_category_name,NEW.main_category_id,CONCAT(t1.first_name,ifnull(t1.middle_name,''),ifnull(t1.last_name,''), t1.medical_record_number),NEW.facility_id,CASE WHEN EXISTS (SELECT * FROM tbl_admissions WHERE account_id = NEW.id AND admission_status_id IN (1,2,3) LIMIT 1) THEN TRUE ELSE FALSE END, NEW.card_no, NEW.authorization_number,(SELECT t02.dept_id FROM tbl_invoice_lines t02 JOIN tbl_item_prices t03 ON t02.patient_id = NEW.patient_id AND t02.item_price_id = t03.id AND t03.sub_category_id = NEW.patient_category_id AND t03.item_id IN(SELECT service_id FROM tbl_registrar_services) AND TIMESTAMPDIFF(day, t02.created_at, CURRENT_DATE) <= (SELECT days FROM tbl_reattendance_free_days t04 WHERE t04.facility_id = NEW.facility_id) AND (t02.status_id = 2 OR t02.is_payable IS NULL) order by t02.id desc limit 1) FROM tbl_patients t1 WHERE t1.id = NEW.patient_id AND (NEW.main_category_id <> 1 OR EXISTS(SELECT t2.id FROM tbl_invoice_lines t2 JOIN tbl_item_prices t3 ON t2.patient_id = NEW.patient_id AND t2.item_price_id = t3.id AND t3.sub_category_id = NEW.patient_category_id AND t3.item_id IN(SELECT service_id FROM tbl_registrar_services) AND TIMESTAMPDIFF(day, t2.created_at, CURRENT_DATE) <= (SELECT days FROM tbl_reattendance_free_days t4 WHERE t4.facility_id = NEW.facility_id) AND (t2.status_id = 2 OR t2.is_payable IS NULL))); END IF; END//
DELIMITER ;
truncate opd_patients;
INSERT INTO opd_patients(`patient_id`,`first_name`,`middle_name`,`last_name`,`medical_record_number`,`name`,`residence_id`,`dob`,`age`,`gender`,`account_number`,`status`,`tallied`,`account_id`,`visit_date`,`payment_filter` ,`bill_id`,`sub_category_name`,`main_category_id`,`search_key`,`facility_id`, `is_admitted`, `card_no`, `authorization_number`, department_id) SELECT t1.id,t1.first_name,t1.middle_name,t1.last_name,t1.medical_record_number,CONCAT(t1.first_name,' ',ifnull(t1.middle_name,''),' ',ifnull(t1.last_name,''), ' ', t1.medical_record_number),t1.residence_id,t1.dob,CASE WHEN STR_TO_DATE(dob,'%Y-%m-%d') IS NOT NULL THEN CASE WHEN TIMESTAMPDIFF(YEAR,dob, CURRENT_DATE) <> 0 THEN CONCAT(TIMESTAMPDIFF(YEAR,dob, CURRENT_DATE), ' Years') ELSE CASE WHEN TIMESTAMPDIFF(MONTH,dob, CURRENT_DATE) <> 0 THEN CONCAT(TIMESTAMPDIFF(MONTH, dob, CURRENT_DATE), ' Months') ELSE CONCAT(TIMESTAMPDIFF(DAY, dob, CURRENT_DATE), ' Days') END END ELSE dob END,t1.gender,t2.account_number,t2.status,t2.tallied,t2.id,t2.date_attended,(select t4.patient_category_id from tbl_accounts_numbers t4 where t4.patient_id = t1.id and main_category_id IS NOT NULL order by id desc limit 1),(select t4.patient_category_id from tbl_accounts_numbers t4 where t4.patient_id = t1.id and main_category_id IS NOT NULL order by id desc limit 1),(select t4.sub_category_name from tbl_accounts_numbers t4 where t4.patient_id = t1.id and main_category_id IS NOT NULL order by id desc limit 1),(select t4.main_category_id from tbl_accounts_numbers t4 where t4.patient_id = t1.id and main_category_id IS NOT NULL order by id desc limit 1),CONCAT(t1.first_name,ifnull(t1.middle_name,''),ifnull(t1.last_name,''), t1.medical_record_number),t2.facility_id, CASE WHEN EXISTS (SELECT * FROM tbl_admissions WHERE account_id = t2.id AND admission_status_id IN (1,2,3) LIMIT 1) THEN TRUE ELSE FALSE END, t2.card_no, t2.authorization_number, (SELECT t04.dept_id FROM tbl_invoice_lines t04 JOIN tbl_item_prices t05 ON t04.item_price_id = t05.id AND t05.item_id IN(SELECT service_id FROM tbl_registrar_services) INNER JOIN tbl_reattendance_free_days t03 ON t03.facility_id = t04.facility_id AND timestampdiff(day, t04.created_at, current_date) <= t03.days WHERE t04.patient_id=t1.id AND (t04.status_id = 2 OR t04.is_payable IS NOT TRUE) order by t04.id desc limit 1) FROM tbl_patients t1 INNER JOIN tbl_accounts_numbers t2 ON t2.visit_close = 1 AND t2.main_category_id IS NOT NULL AND t2.patient_id = t1.id INNER JOIN tbl_reattendance_free_days t3 ON t3.facility_id = t2.facility_id AND timestampdiff(day, t2.date_attended, current_date) <= t3.days AND EXISTS(SELECT t4.id FROM tbl_invoice_lines t4 JOIN tbl_item_prices t5 ON t4.item_price_id = t5.id AND t5.item_id IN(SELECT service_id FROM tbl_registrar_services) WHERE t4.patient_id=t1.id AND TIMESTAMPDIFF(day, t4.created_at, CURRENT_DATE) <= t3.days AND (t4.status_id = 2 OR t4.is_payable IS NOT TRUE OR t4.payment_filter = 3)) order by t2.id;